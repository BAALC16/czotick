name: Deploy to VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  PHP_VERSION: '8.1'

jobs:
  deploy:
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            
            # Variables
            APP_DIR="${{ secrets.APP_DIRECTORY }}"
            REPO_URL="https://github.com/${{ github.repository }}.git"
            BRANCH="${{ github.ref_name }}"
            
            echo "ðŸš€ DÃ©marrage du dÃ©ploiement..."
            
            # CrÃ©er le rÃ©pertoire si nÃ©cessaire
            mkdir -p $APP_DIR
            cd $APP_DIR
            
            # Cloner ou mettre Ã  jour le repository
            if [ -d ".git" ]; then
              echo "ðŸ“¥ Mise Ã  jour du code..."
              git fetch origin
              git reset --hard origin/$BRANCH
              git clean -fd
            else
              echo "ðŸ“¥ Clonage du repository..."
              git clone -b $BRANCH $REPO_URL .
            fi
            
            # Copier le fichier .env si nÃ©cessaire
            if [ ! -f ".env" ]; then
              echo "ðŸ“ CrÃ©ation du fichier .env..."
              cp .env.example .env
            fi
            
            # ArrÃªter les conteneurs existants
            echo "ðŸ›‘ ArrÃªt des conteneurs..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            
            # Construire les nouvelles images
            echo "ðŸ”¨ Construction des images..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            
            # DÃ©marrer les conteneurs
            echo "â–¶ï¸  DÃ©marrage des conteneurs..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            
            # Attendre que les services soient prÃªts
            echo "â³ Attente du dÃ©marrage des services..."
            sleep 10
            
            # Installer les dÃ©pendances Composer
            echo "ðŸ“¦ Installation des dÃ©pendances Composer..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app composer install --no-dev --optimize-autoloader --no-interaction || true
            
            # Installer les dÃ©pendances NPM
            echo "ðŸ“¦ Installation des dÃ©pendances NPM..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app npm ci --production || true
            
            # Compiler les assets
            echo "ðŸŽ¨ Compilation des assets..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app npm run build || true
            
            # ExÃ©cuter les migrations
            echo "ðŸ—„ï¸  ExÃ©cution des migrations..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app php artisan migrate --force || true
            
            # Optimiser l'application
            echo "âš¡ Optimisation de l'application..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app php artisan config:cache || true
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app php artisan route:cache || true
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app php artisan view:cache || true
            
            # CrÃ©er le lien symbolique pour le storage
            echo "ðŸ”— CrÃ©ation du lien symbolique..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml exec -T app php artisan storage:link || true
            
            # RedÃ©marrer les conteneurs pour appliquer les changements
            echo "ðŸ”„ RedÃ©marrage des conteneurs..."
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml restart
            
            # Nettoyer les images inutilisÃ©es
            echo "ðŸ§¹ Nettoyage..."
            docker system prune -f
            
            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s!"
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… DÃ©ploiement rÃ©ussi!"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement"
          fi

